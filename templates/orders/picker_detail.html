{% extends "base.html" %}

{% block title %}Сборка заказа{% endblock %}
{% block sidebar %}{% include "partials/sidebars/picker.html" %}{% endblock %}
{% block topbar_title %}Сборка заказа{% endblock %}
{% block breadcrumbs %}
  <a href="/orders/picker/">Заказы в работе</a> / Сборка заказа
{% endblock %}

{% block content %}
  <div class="section-header">
    <h4 class="mb-0">Заказ №{{ order.order_number }}</h4>
    <div class="d-flex gap-2">
      <span class="badge-soft {% if order.status == 'Отменен' %}danger{% elif order.status == 'Отгружен' %}primary{% elif order.status == 'Подтвержден производством' %}success{% else %}warn{% endif %}">
        {{ order.status }}
      </span>
      <a href="/orders/picker/" class="btn btn-outline-secondary">К списку</a>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-lg-8">
      <div class="card">
        <h6>Данные заказа</h6>
        <div class="row g-3 mt-1">
          <div class="col-md-6"><strong>Клиент:</strong> {{ order.client.name }}</div>
          <div class="col-md-6"><strong>Дата:</strong> {{ order.created_at|date:"d.m.Y H:i" }}</div>
          <div class="col-md-6"><strong>Сумма:</strong> {{ order.total_amount }}</div>
          <div class="col-md-6"><strong>Адрес:</strong> {{ order.address|default:"—" }}</div>
          <div class="col-12"><strong>Комментарий клиента:</strong> {{ order.comments|default:"—" }}</div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <h6>История сборки</h6>
        <div class="small text-muted">Сборщик</div>
        <div class="fw-semibold mb-2">{{ session.picker.full_name|default:"—" }}</div>
        <div class="small text-muted">Начата</div>
        <div class="mb-2">{{ session.started_at|date:"d.m.Y H:i"|default:"—" }}</div>
        <div class="small text-muted">Завершена</div>
        <div class="mb-2">{{ session.finished_at|date:"d.m.Y H:i"|default:"—" }}</div>
      </div>
    </div>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}
    {{ formset.management_form }}
    <div class="card mb-3">
      <h6>Позиции заказа</h6>
      <div class="table-responsive">
        <table class="table mb-0">
          <thead>
            <tr>
              <th>Позиция</th>
              <th>Заказано</th>
              <th>Собрано фактически</th>
              <th>Статус</th>
              <th>Комментарий</th>
              <th>Замена</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for form in formset %}
              <tr>
                <td class="fw-semibold">{{ form.instance.display_name }}</td>
                <td>{{ form.instance.quantity }}</td>
                <td>{{ form.picked_quantity }}</td>
                <td>{{ form.item_status }}</td>
                <td>{{ form.item_comment }}</td>
                <td>{{ form.replacement_text }}</td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-set-status="done" data-item="{{ forloop.counter0 }}">Собрано</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-set-status="out_of_stock" data-item="{{ forloop.counter0 }}">Нет в наличии</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-set-status="replaced" data-item="{{ forloop.counter0 }}">Замена</button>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="text-muted">Позиции не найдены</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card mb-3">
      <h6>Примечание сборщика</h6>
      {{ session_form.note }}
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" name="action" value="save">Сохранить изменения</button>
      <button class="btn btn-primary" name="action" value="finish" onclick="return confirm('Завершить сборку и передать в доставку?');">
        Завершить сборку и передать в доставку
      </button>
    </div>
  </form>

  <script>
    const rows = Array.from(document.querySelectorAll("tbody tr"));
    rows.forEach((row, index) => {
      row.querySelectorAll("[data-set-status]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const status = btn.getAttribute("data-set-status");
          const statusSelect = row.querySelector('select[name$="item_status"]');
          const pickedInput = row.querySelector('input[name$="picked_quantity"]');
          const ordered = row.children[1].textContent.trim();
          statusSelect.value = status;
          if (status === "done" && pickedInput && !pickedInput.value) {
            pickedInput.value = ordered;
          }
          if (status === "out_of_stock") {
            row.querySelector('input[name$="item_comment"]').focus();
          }
          if (status === "replaced") {
            row.querySelector('input[name$="replacement_text"]').focus();
          }
        });
      });
    });
  </script>
{% endblock %}
