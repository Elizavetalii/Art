{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}
{% block sidebar %}
  {% if is_admin %}
    {% include "partials/sidebars/admin.html" %}
  {% else %}
    {% include "partials/sidebars/manager.html" %}
  {% endif %}
{% endblock %}
{% block topbar_title %}{{ title }}{% endblock %}
{% block breadcrumbs %}
  <a href="/orders/">Заказы</a> / {{ title }}
{% endblock %}

{% block content %}
  <div class="card">
    <form method="post" novalidate data-order-id="{{ form.instance.pk|default_if_none:'' }}">
      {% csrf_token %}
      <div class="row g-3">
        {% for field in form %}
          <div class="col-md-6">
            <label class="form-label">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}
              <div class="text-danger small mt-1">{{ field.errors|striptags }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      {% if warnings %}
        <div class="mt-3">
          <div class="text-warning fw-semibold">Предупреждения</div>
          <ul class="mb-0">
            {% for w in warnings %}
              <li>{{ w }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      {% if info %}
        <div class="mt-3">
          <div class="fw-semibold">Подсказки производства</div>
          <div class="small text-muted">Доступно к производству: {{ info.production_capacity|default:"—" }} кг</div>
          <div class="small text-muted">Уже запланировано: {{ info.production_reserved|default:"—" }} кг</div>
          <div class="small text-muted">Вес текущего заказа: {{ info.order_weight|default:"—" }} кг</div>
          {% if info.client_daily_limit %}
            <div class="small text-muted">Лимит клиента: {{ info.client_daily_limit }} кг (занято {{ info.client_reserved }})</div>
          {% endif %}
        </div>
      {% endif %}
      {% if formset %}
        <div class="mt-4">
          <h6>Позиции заказа</h6>
          <div class="text-muted small mb-2" id="delivery-hint">Сначала выберите дату доставки.</div>
          {{ formset.management_form }}
          <div class="table-responsive">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>Блюдо</th>
                  <th>Кол-во</th>
                  <th>Цена</th>
                  <th>Сумма</th>
                  <th>Тип</th>
                  <th>Комментарий</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="items-body">
                {% for f in formset %}
                  <tr class="item-row">
                    <td>{{ f.dish }}</td>
                    <td>
                      {{ f.quantity }}
                      <div class="small text-muted available-qty"></div>
                    </td>
                    <td>{{ f.unit_price }}</td>
                    <td><span class="line-total">—</span></td>
                    <td>{{ f.supply_type }}</td>
                    <td>{{ f.item_comment }}</td>
                    <td>
                      {% if f.DELETE %}
                        <label class="small">{{ f.DELETE }} Удалить</label>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="text-warning small mt-2" id="qty-warning" style="display:none"></div>
          <div class="text-danger small mt-2" id="price-warning" style="display:none"></div>
          <div class="mt-2">
            <button type="button" class="btn btn-outline-secondary" id="add-item">Добавить позицию</button>
          </div>
        </div>
      {% endif %}
      <div class="d-flex gap-2 mt-4">
        <button class="btn btn-primary">Сохранить</button>
        <a href="/orders/" class="btn btn-outline-secondary">Отмена</a>
      </div>
    </form>
  </div>

  {% if dish_prices %}
    {{ dish_prices|json_script:"dish-price-data" }}
  {% endif %}

  {% if formset %}
    <template id="empty-form">
      <tr class="item-row">
        <td>{{ formset.empty_form.dish }}</td>
        <td>
          {{ formset.empty_form.quantity }}
          <div class="small text-muted available-qty"></div>
        </td>
        <td>{{ formset.empty_form.unit_price }}</td>
        <td><span class="line-total">—</span></td>
        <td>{{ formset.empty_form.supply_type }}</td>
        <td>{{ formset.empty_form.item_comment }}</td>
        <td></td>
      </tr>
    </template>
    <script>
      (function() {
        const addBtn = document.getElementById("add-item");
        const body = document.getElementById("items-body");
        const template = document.getElementById("empty-form");
        if (!addBtn || !body || !template) return;
        addBtn.addEventListener("click", () => {
          const totalInput = document.getElementById("id_form-TOTAL_FORMS");
          const index = parseInt(totalInput.value, 10);
          const html = template.innerHTML.replace(/__prefix__/g, index);
          body.insertAdjacentHTML("beforeend", html);
          totalInput.value = index + 1;
        });
      })();
    </script>
    <script>
      (function() {
        const body = document.getElementById("items-body");
        const dateInput = document.getElementById("id_delivery_date");
        const totalInput = document.getElementById("id_total_amount");
        const form = document.querySelector("form[data-order-id]");
        const warning = document.getElementById("qty-warning");
        const priceWarning = document.getElementById("price-warning");
        const hint = document.getElementById("delivery-hint");
        const addBtn = document.getElementById("add-item");
        let totalDisplay = null;
        const priceDataEl = document.getElementById("dish-price-data");
        const fallbackPrices = priceDataEl ? JSON.parse(priceDataEl.textContent) : {};
        if (!body) return;

        const dishCache = new Map();
        let lastDate = null;
        const moneyFormatter = new Intl.NumberFormat("ru-RU", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        function formatDateLocal(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          return `${year}-${month}-${day}`;
        }

        function getDeliveryDate() {
          if (dateInput && dateInput.value) {
            return dateInput.value;
          }
          return formatDateLocal(new Date());
        }

        function fetchPrices() {
          const deliveryDate = getDeliveryDate();
          if (deliveryDate === lastDate && dishCache.size) {
            return Promise.resolve();
          }
          lastDate = deliveryDate;
          dishCache.clear();
          const orderId = form && form.dataset.orderId ? form.dataset.orderId : "";
          const url = `/api/orders/availability/?delivery_date=${encodeURIComponent(deliveryDate)}${orderId ? `&order_id=${encodeURIComponent(orderId)}` : ""}`;
          return fetch(url, { headers: { "Accept": "application/json" } })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Failed to load prices");
              }
              return response.json();
            })
            .then((data) => {
              (data.dishes || []).forEach((dish) => {
                if (!dish.dish_id) return;
                dishCache.set(String(dish.dish_id), {
                  price: dish.price,
                  availableQty: dish.available_qty,
                  unit: dish.unit,
                  baseUom: dish.base_uom,
                  quantityScale: dish.quantity_scale,
                  weightPerUnitKg: dish.weight_per_unit_kg,
                  dailyCapacity: dish.daily_capacity,
                  reservedQty: dish.reserved_qty,
                  maxByCapacity: dish.max_by_capacity,
                });
              });
            })
            .catch(() => {});
        }

        function setRowPrice(row, price) {
          const priceInput = row.querySelector('input[name$="-unit_price"]');
          if (!priceInput) return;
          if (price === null || price === undefined || !Number.isFinite(Number(price))) {
            priceInput.value = "";
            return;
          }
          priceInput.value = Number(price).toFixed(2);
        }

        function setAvailableQty(row, entry) {
          const container = row.querySelector(".available-qty");
          if (!container) return;
          if (!entry || entry.availableQty === null || entry.availableQty === undefined) {
            container.textContent = "";
            return;
          }
          const unit = entry.unit ? ` ${entry.unit}` : "";
          const scale = entry.quantityScale !== undefined ? entry.quantityScale : 3;
          container.textContent = `Доступно: ${formatQty(Number(entry.availableQty), scale)}${unit}`;
        }

        function parseNumber(value) {
          if (value === null || value === undefined) return null;
          const normalized = String(value).replace(",", ".").trim();
          if (!normalized) return null;
          const num = Number(normalized);
          return Number.isFinite(num) ? num : null;
        }

        function formatMoney(value) {
          if (value === null || value === undefined || !Number.isFinite(value)) return "—";
          return moneyFormatter.format(value);
        }

        function formatQty(value, scale) {
          if (value === null || value === undefined || !Number.isFinite(value)) return "—";
          const digits = Number.isFinite(scale) ? scale : 3;
          return value.toFixed(digits);
        }

        function showWarning(message) {
          if (!warning) return;
          if (!message) {
            warning.style.display = "none";
            warning.textContent = "";
            return;
          }
          warning.textContent = message;
          warning.style.display = "block";
        }

        function showPriceWarning(message) {
          if (!priceWarning) return;
          if (!message) {
            priceWarning.style.display = "none";
            priceWarning.textContent = "";
            return;
          }
          priceWarning.textContent = message;
          priceWarning.style.display = "block";
        }

        function setPositionsEnabled(enabled) {
          const inputs = body.querySelectorAll("select, input, textarea, button");
          inputs.forEach((el) => {
            if (enabled) {
              el.removeAttribute("disabled");
            } else {
              el.setAttribute("disabled", "disabled");
            }
          });
          if (addBtn) {
            if (enabled) {
              addBtn.removeAttribute("disabled");
            } else {
              addBtn.setAttribute("disabled", "disabled");
            }
          }
          if (hint) {
            hint.style.display = enabled ? "none" : "block";
          }
        }

        function applyQtyLimit(row, availableQty) {
          const qtyInput = row.querySelector('input[name$="-quantity"]');
          if (!qtyInput) return;
          if (availableQty === null || availableQty === undefined || !Number.isFinite(Number(availableQty))) {
            qtyInput.removeAttribute("max");
            showWarning("");
            return;
          }
          const maxValue = Number(availableQty);
          qtyInput.setAttribute("max", String(maxValue));
          const current = parseNumber(qtyInput.value);
          if (current !== null && current > maxValue) {
            const dishSelect = row.querySelector('select[name$="-dish"]');
            const entry = dishSelect ? dishCache.get(String(dishSelect.value)) : null;
            const scale = entry && entry.quantityScale !== undefined ? entry.quantityScale : 3;
            qtyInput.value = formatQty(maxValue, scale);
            showWarning(`Количество уменьшено до доступного: ${formatQty(maxValue, scale)}.`);
          } else {
            showWarning("");
          }
        }

        function updateLineTotal(row) {
          const qtyInput = row.querySelector('input[name$="-quantity"]');
          const priceInput = row.querySelector('input[name$="-unit_price"]');
          const display = row.querySelector(".line-total");
          if (!display) return 0;
          const qty = parseNumber(qtyInput ? qtyInput.value : null);
          const price = parseNumber(priceInput ? priceInput.value : null);
          if (qty === null || price === null) {
            display.textContent = price === null ? "Цена не задана" : "—";
            return 0;
          }
          const total = qty * price;
          display.textContent = formatMoney(total);
          return total;
        }

        function updateOrderTotal() {
          let total = 0;
          body.querySelectorAll("tr.item-row").forEach((row) => {
            total += updateLineTotal(row);
          });
          if (totalInput) {
            totalInput.value = Number.isFinite(total) ? total.toFixed(2) : "";
          }
          if (totalInput) {
            if (!totalDisplay) {
              totalDisplay = document.createElement("div");
              totalDisplay.className = "small text-muted";
              totalInput.parentElement && totalInput.parentElement.appendChild(totalDisplay);
            }
            totalDisplay.textContent = Number.isFinite(total) ? `Итого: ${formatMoney(total)}` : "";
          }
        }

        function configureQuantityInput(row, entry) {
          const qtyInput = row.querySelector('input[name$="-quantity"]');
          if (!qtyInput || !entry) return;
          if (entry.baseUom === "kg") {
            qtyInput.setAttribute("step", "0.001");
            qtyInput.setAttribute("inputmode", "decimal");
            qtyInput.setAttribute("pattern", "[0-9]+([.,][0-9]{1,3})?");
          } else {
            qtyInput.setAttribute("step", "1");
            qtyInput.setAttribute("inputmode", "numeric");
            qtyInput.setAttribute("pattern", "[0-9]*");
          }
        }

        function updateRow(row) {
          const dishSelect = row.querySelector('select[name$="-dish"]');
          if (!dishSelect || !dishSelect.value) return;
          const entry = dishCache.get(String(dishSelect.value));
          if (entry) {
            if (entry.price !== undefined) {
              setRowPrice(row, entry.price);
            }
            setAvailableQty(row, entry);
            applyQtyLimit(row, entry.availableQty);
            configureQuantityInput(row, entry);
          } else {
            setAvailableQty(row, null);
            applyQtyLimit(row, null);
            const fallback = fallbackPrices[dishSelect.value];
            if (fallback !== undefined) {
              setRowPrice(row, fallback);
            }
          }
          updateLineTotal(row);
          updateOrderTotal();
        }

        function refreshAllRows() {
          body.querySelectorAll("tr.item-row").forEach(updateRow);
          updateOrderTotal();
        }

        body.addEventListener("change", (event) => {
          const target = event.target;
          if (!target || target.tagName !== "SELECT" || !target.name.endsWith("-dish")) return;
          const row = target.closest("tr");
          fetchPrices().then(() => updateRow(row));
        });

        body.addEventListener("input", (event) => {
          const target = event.target;
          if (!target) return;
          if (target.name && (target.name.endsWith("-quantity") || target.name.endsWith("-unit_price"))) {
            const row = target.closest("tr");
            if (row) {
              const dishSelect = row.querySelector('select[name$="-dish"]');
              if (dishSelect && dishSelect.value) {
                const entry = dishCache.get(String(dishSelect.value));
                if (entry) {
                  if (target.name.endsWith("-quantity") && entry.baseUom !== "kg") {
                    if (target.value !== "") {
                      const sanitized = target.value.replace(/[^\d]/g, "");
                      if (sanitized !== target.value) {
                        target.value = sanitized;
                      }
                    }
                  }
                  applyQtyLimit(row, entry.availableQty);
                }
              }
              updateLineTotal(row);
              updateOrderTotal();
            }
          }
        });

        if (dateInput) {
          dateInput.addEventListener("change", () => {
            fetchPrices().then(() => {
              refreshAllRows();
              showWarning("Цены пересчитаны по новой дате.");
            });
          });
        }

        const hasDate = dateInput && dateInput.value;
        setPositionsEnabled(!!hasDate);
        if (hasDate) {
          fetchPrices().then(refreshAllRows);
        }

        if (dateInput) {
          dateInput.addEventListener("change", () => {
            const enabled = !!dateInput.value;
            setPositionsEnabled(enabled);
            if (enabled) {
              fetchPrices().then(refreshAllRows);
            } else {
              body.querySelectorAll(".line-total").forEach((el) => (el.textContent = "—"));
              if (totalInput) totalInput.value = "";
            }
          });
        }

        if (form) {
          form.addEventListener("submit", (event) => {
            let hasMissingPrice = false;
            body.querySelectorAll("tr.item-row").forEach((row) => {
              const dishSelect = row.querySelector('select[name$="-dish"]');
              const priceInput = row.querySelector('input[name$="-unit_price"]');
              if (dishSelect && dishSelect.value) {
                if (priceInput && !priceInput.value && fallbackPrices[dishSelect.value] !== undefined) {
                  setRowPrice(row, fallbackPrices[dishSelect.value]);
                }
                const price = parseNumber(priceInput ? priceInput.value : null);
                if (price === null) {
                  hasMissingPrice = true;
                }
              }
            });
            if (hasMissingPrice) {
              event.preventDefault();
              showPriceWarning("Цена не задана для одной или нескольких позиций. Сохранение невозможно.");
            } else {
              showPriceWarning("");
            }
          });
        }
      })();
    </script>
  {% endif %}
{% endblock %}
