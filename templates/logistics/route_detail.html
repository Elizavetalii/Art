{% extends "base.html" %}

{% block title %}Маршрут{% endblock %}
{% block sidebar %}{% include "partials/sidebars/logistic.html" %}{% endblock %}
{% block topbar_title %}Маршрут{% endblock %}
{% block breadcrumbs %}
  <a href="/logistics/routes/">Маршруты</a> / Детали
{% endblock %}

{% block content %}
  <div class="section-header">
    <h4 class="mb-0">Маршрут на {{ route.planned_date|date:"d.m.Y" }}</h4>
    <a href="/logistics/routes/" class="btn btn-outline-secondary">Назад</a>
  </div>

  <div class="card mb-3">
    <div class="section-header">
      <h6 class="mb-0">Проверка маршрута</h6>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="publish_route">
        <button class="btn btn-primary" {% if route_errors %}disabled{% endif %}>
          Опубликовать маршрут
        </button>
      </form>
    </div>
    <div class="row g-2">
      <div class="col-md-4">
        <div class="small text-muted">Прогноз времени</div>
        <div class="fw-semibold">{{ route_duration_minutes }} мин / {{ route.max_duration_minutes }} мин</div>
      </div>
      <div class="col-md-4">
        <div class="small text-muted">Километраж</div>
        <div class="fw-semibold">{{ route_distance_km }} км</div>
      </div>
      <div class="col-md-4">
        <div class="small text-muted">Количество точек</div>
        <div class="fw-semibold">{{ total_points }} / {{ route.soft_limit_stops }}</div>
      </div>
      <div class="col-md-4">
        <div class="small text-muted">Вес</div>
        <div class="fw-semibold">{{ total_weight }}</div>
      </div>
      <div class="col-md-4">
        <div class="small text-muted">Объём</div>
        <div class="fw-semibold">{{ total_volume }}</div>
      </div>
    </div>
    {% if route_errors %}
      <div class="mt-3">
        <div class="text-danger fw-semibold">Невалидно:</div>
        <ul class="mb-0">
          {% for e in route_errors %}
            <li>{{ e }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    {% if route_warnings %}
      <div class="mt-2">
        <div class="text-warning fw-semibold">Предупреждения:</div>
        <ul class="mb-0">
          {% for w in route_warnings %}
            <li>{{ w }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card">
        <h6>Назначенные курьеры</h6>
        <ul class="list-group list-group-flush mb-3">
          {% for a in assignments %}
            <li class="list-group-item bg-transparent">{{ a.courier.user.full_name }}</li>
          {% empty %}
            <li class="list-group-item text-muted bg-transparent">Курьеры не назначены</li>
          {% endfor %}
        </ul>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="assign_courier">
          <div class="mb-2">{{ assign_form.courier }}</div>
          <button class="btn btn-outline-secondary w-100">Назначить курьера</button>
        </form>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card">
        <h6>Добавить остановку</h6>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_stop">
          <div class="mb-2">{{ stop_form.delivery }}</div>
          <div class="mb-2">{{ stop_form.planned_time }}</div>
          <div class="mb-2">{{ stop_form.note }}</div>
          <div class="mb-2">{{ stop_form.status }}</div>
          <button class="btn btn-primary w-100">Добавить</button>
        </form>
      </div>
    </div>
  </div>

  <div class="card mt-3">
    <h6>Остановки маршрута</h6>
    <div class="table-responsive">
      <table class="table mb-0">
        <thead>
          <tr>
            <th>Порядок</th>
            <th>Заказ</th>
            <th>Адрес</th>
            <th>План</th>
            <th>Статус</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for s in stops %}
            <tr>
              <td>{{ s.sequence_index }}</td>
              <td>{{ s.delivery.order.order_number }}</td>
              <td>{{ s.delivery.address|default:"—" }}</td>
              <td>{{ s.planned_time|date:"d.m.Y H:i"|default:"—" }}</td>
              <td>
                <span class="badge-soft {% if s.status == 'Доставлено' %}success{% elif s.status == 'В пути' %}warn{% elif s.status == 'Не доставлено' %}danger{% else %}primary{% endif %}">
                  {{ s.status }}
                </span>
              </td>
              <td class="text-end">
                <form method="post" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="move_up">
                  <input type="hidden" name="stop_id" value="{{ s.id }}">
                  <button class="btn btn-sm btn-outline-secondary">↑</button>
                </form>
                <form method="post" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="move_down">
                  <input type="hidden" name="stop_id" value="{{ s.id }}">
                  <button class="btn btn-sm btn-outline-secondary">↓</button>
                </form>
                <form method="post" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="remove_stop">
                  <input type="hidden" name="stop_id" value="{{ s.id }}">
                  <input type="hidden" name="reason" value="Удалено логистом">
                  <button class="btn btn-sm btn-outline-secondary">Удалить</button>
                </form>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="text-muted">Остановок пока нет</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card mt-3">
    <h6>Карта маршрута</h6>
    <div id="route-map" style="height: 360px;"></div>
  </div>

  {{ map_payload|json_script:"route-data" }}
  <script>
    async function geocodeAddress(address) {
      const url = "https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(address);
      const res = await fetch(url, { headers: { "Accept-Language": "ru" } });
      const data = await res.json();
      if (!data.length) return null;
      return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
    }

    async function initRouteMap() {
      const payload = JSON.parse(document.getElementById("route-data").textContent || "{}");
      const mapEl = document.getElementById("route-map");
      if (!mapEl) return;
      const map = L.map(mapEl);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap",
      }).addTo(map);

      const points = [];
      for (const stop of payload.stops || []) {
        let point = null;
        if (stop.lat && stop.lng) {
          point = { lat: stop.lat, lng: stop.lng };
        } else if (stop.address) {
          point = await geocodeAddress(stop.address);
        }
        if (point) {
          points.push(point);
          L.marker([point.lat, point.lng]).addTo(map).bindPopup(stop.address || "Остановка");
        }
      }

      if (points.length) {
        const latLngs = points.map((p) => [p.lat, p.lng]);
        L.polyline(latLngs, { color: "#3b82f6" }).addTo(map);
        map.fitBounds(latLngs, { padding: [30, 30] });
      } else {
        map.setView([55.751244, 37.618423], 10);
      }
    }
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>initRouteMap();</script>
{% endblock %}
