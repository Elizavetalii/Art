stages:
  - build
  - lint
  - api
  - security

variables:
  VENV_PATH: ".venv"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DJANGO_SETTINGS_MODULE: "factory_crm.settings"
  SECRET_KEY: "ci-temp-secret"
  DEBUG: "true"
  ALLOWED_HOSTS: "localhost,127.0.0.1"

cache:
  key: "venv-$CI_COMMIT_REF_SLUG"
  paths:
    - .cache/pip/
    - .venv/

before_script:
  - echo "Подготовка виртуального окружения и установка зависимостей"
  - python3 --version
  - python3 -m venv "$VENV_PATH"
  - source "$VENV_PATH/bin/activate"
  - python -m pip install --upgrade pip
  - pip install -r requirements.txt

build:check:
  stage: build
  script:
    - echo "Проверяю корректность конфигурации Django"
    - source "$VENV_PATH/bin/activate"
    - python manage.py check
    - echo "Проверка конфигурации завершена успешно"

build:collectstatic:
  stage: build
  script:
    - echo "Собираю статические файлы"
    - source "$VENV_PATH/bin/activate"
    - python manage.py collectstatic --noinput
    - echo "Статические файлы собраны"
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - staticfiles/

lint:ruff:
  stage: lint
  script:
    - echo "Запускаю линтер Ruff"
    - source "$VENV_PATH/bin/activate"
    - pip install ruff
    - mkdir -p reports
    - ruff check . --output-format=json > reports/ruff.json || true
    - echo "Отчет Ruff сформирован"
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - reports/ruff.json
  allow_failure: true

api:schema:
  stage: api
  script:
    - echo "Генерирую OpenAPI схему"
    - source "$VENV_PATH/bin/activate"
    - mkdir -p artifacts
    - python manage.py spectacular --file artifacts/openapi.yaml
    - echo "OpenAPI схема создана"
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - artifacts/openapi.yaml

security:bandit:
  stage: security
  script:
    - echo "Запускаю анализ безопасности Bandit"
    - source "$VENV_PATH/bin/activate"
    - pip install bandit
    - mkdir -p reports
    - bandit -r . -f json -o reports/bandit.json || true
    - echo "Отчет Bandit сформирован"
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - reports/bandit.json
  allow_failure: true

security:pip-audit:
  stage: security
  script:
    - echo "Проверяю зависимости на известные уязвимости"
    - source "$VENV_PATH/bin/activate"
    - pip install pip-audit
    - mkdir -p reports
    - pip-audit -r requirements.txt -f json -o reports/pip-audit.json || true
    - echo "Отчет pip-audit сформирован"
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - reports/pip-audit.json
  allow_failure: true
